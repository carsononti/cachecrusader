<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport"
          content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <meta name="format-detection" content="telephone=no">
    <title>Kaboom Demo — Touch Controls (All-in-one)</title>
    <style>
        :root {
            --pad: 14px;
            --btn: 64px;
            --safe-left: env(safe-area-inset-left, 0px);
            --safe-right: env(safe-area-inset-right, 0px);
            --safe-bottom: env(safe-area-inset-bottom, 0px);
        }

        html, body {
            margin: 0;
            height: 100%;
            background: #0b1b2b;
        }

        #game {
            position: fixed;
            inset: 0;
            display: grid;
            place-items: center;
        }

            #game canvas {
                image-rendering: pixelated;
            }

        .hud {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 10;
        }

        .controls {
            position: absolute;
            left: calc(var(--pad) + var(--safe-left));
            bottom: calc(var(--pad) + var(--safe-bottom));
            display: grid;
            grid-template-columns: var(--btn) var(--btn) var(--btn);
            grid-template-rows: var(--btn) var(--btn) var(--btn);
            gap: 8px;
            pointer-events: none;
            -webkit-user-select: none;
            user-select: none;
            touch-action: none;
        }

            .controls button {
                pointer-events: auto;
                width: var(--btn);
                height: var(--btn);
                border-radius: 3px; /* small radius = blocky */
                border: 3px solid #222; /* thick pixel border */
                background: #444; /* flat gray fill */
                color: #fff;
                font: bold 20px monospace; /* monospace = retro */
                text-shadow: 1px 1px 0 #000; /* pixel-style text */
                image-rendering: pixelated;
                touch-action: none;
            }

                .controls button:active {
                    background: #222;
                    border-color: #ffcc00; /* golden highlight on press */
                    color: #ffcc00;
                }

        .btn-up {
            grid-area: 1 / 2;
        }

        .btn-left {
            grid-area: 2 / 1;
        }

        .btn-down {
            grid-area: 3 / 2;
        }

        .btn-right {
            grid-area: 2 / 3;
        }

        .action-wrap {
            position: absolute;
            right: calc(var(--pad) + var(--safe-right));
            bottom: calc(var(--pad) + var(--safe-bottom));
            pointer-events: none;
            touch-action: none;
        }

            .action-wrap button {
                pointer-events: auto;
                width: calc(var(--btn) * 1.2);
                height: calc(var(--btn) * 1.2);
                border-radius: 3px;
                border: 3px solid #222;
                background: #800; /* deep red fill */
                color: #fff;
                font: bold 20px monospace;
                text-shadow: 1px 1px 0 #000;
                image-rendering: pixelated;
                touch-action: none;
            }

                .action-wrap button:active {
                    background: #c00;
                    border-color: #ffcc00;
                    color: #ffcc00;
                }

        @media (max-width: 420px) {
            :root {
                --btn: 56px;
                --pad: 10px;
            }
        }

        /* iOS quirks fix */
        html, body, #game, #game canvas,
        .hud, .controls, .controls button,
        .action-wrap, .action-wrap button {
            -webkit-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }

        * {
            -webkit-tap-highlight-color: rgba(0,0,0,0);
        }

        canvas, img {
            -webkit-user-drag: none;
            user-drag: none;
        }
    </style>

</head>
<body>
    <div id="game"></div>

    <div class="hud" aria-hidden="false">
        <div class="controls" id="dpad" role="group" aria-label="Movement">
            <button class="btn-up" data-dir="up" aria-label="Up">▲</button>
            <button class="btn-left" data-dir="left" aria-label="Left">◀</button>
            <button class="btn-down" data-dir="down" aria-label="Down">▼</button>
            <button class="btn-right" data-dir="right" aria-label="Right">▶</button>
        </div>
        <div class="action-wrap">
            <button id="btn-action" aria-label="Action">A</button>
        </div>
    </div>

    <script type="module">
        import kaboom from "https://cdn.jsdelivr.net/npm/kaboom@3000/dist/kaboom.mjs";

        // ===== Fixed internal resolution (prevents scale drift on rotate) =====
        const GAME_W = 320;   // multiples of 16 recommended
        const GAME_H = 180;

        kaboom({
            root: document.querySelector("#game"),
            width: GAME_W,
            height: GAME_H,
            background: [0, 0, 0],
            crisp: true,
            letterbox: true,
            stretch: false,
        });

        // ===== iOS interaction hard-stops (single-file) =====
        // Prevent text selection and context menu globally
        document.addEventListener("selectstart", (e) => e.preventDefault());
        document.addEventListener("contextmenu", (e) => e.preventDefault(), { passive: false });

        // Soft block double-tap zoom without killing pinch-zoom accessibility
        let lastTouch = 0;
        window.addEventListener("touchend", (e) => {
            const now = Date.now();
            if (now - lastTouch < 350) { e.preventDefault(); }
            lastTouch = now;
        }, { passive: false });

        // ===== Sprites / Atlas =====
        loadSpriteAtlas("sprites/dungeon.png", {
            "hero": {
                "x": 128, "y": 196, "width": 144, "height": 28, "sliceX": 9,
                "anims": {
                    "idle": { "from": 0, "to": 3, "speed": 3, "loop": true },
                    "run": { "from": 4, "to": 7, "speed": 10, "loop": true },
                    "hit": 8
                }
            },
            "ogre": {
                "x": 16, "y": 320, "width": 256, "height": 32, "sliceX": 8,
                "anims": {
                    "idle": { "from": 0, "to": 3, "speed": 3, "loop": true },
                    "run": { "from": 4, "to": 7, "speed": 10, "loop": true }
                }
            },
            "floor": { "x": 16, "y": 64, "width": 48, "height": 48, "sliceX": 3, "sliceY": 3 },
            "chest": {
                "x": 304, "y": 304, "width": 48, "height": 16, "sliceX": 3,
                "anims": {
                    "open": { "from": 0, "to": 2, "speed": 20, "loop": false },
                    "close": { "from": 2, "to": 0, "speed": 20, "loop": false }
                }
            },
            "wall": { "x": 16, "y": 16, "width": 16, "height": 16 },
            "wall_top": { "x": 16, "y": 0, "width": 16, "height": 16 },
            "wall_left": { "x": 16, "y": 128, "width": 16, "height": 16 },
            "wall_right": { "x": 0, "y": 128, "width": 16, "height": 16 },
            "wall_topleft": { "x": 32, "y": 128, "width": 16, "height": 16 },
            "wall_topright": { "x": 48, "y": 128, "width": 16, "height": 16 },
            "wall_botleft": { "x": 32, "y": 144, "width": 16, "height": 16 },
            "wall_botright": { "x": 48, "y": 144, "width": 16, "height": 16 }
        });

        // ===== Levels =====
        addLevel([
            "xxxxxxxxxx",
            "          ",
            "          ",
            "          ",
            "          ",
            "          ",
            "          ",
            "          ",
            "          ",
            "          ",
        ], {
            tileWidth: 16,
            tileHeight: 16,
            tiles: { " ": () => [sprite("floor", { frame: ~~rand(0, 8) })] },
        });

        const map = addLevel([
            "tttttttttt",
            "cwwwwwwwwd",
            "l        r",
            "l        r",
            "l        r",
            "l      $ r",
            "l        r",
            "l $      r",
            "attttttttb",
            "wwwwwwwwww",
        ], {
            tileWidth: 16,
            tileHeight: 16,
            tiles: {
                "$": () => [sprite("chest"), area(), body({ isStatic: true }), tile({ isObstacle: true }), { opened: false }, "chest"],
                "a": () => [sprite("wall_botleft"), area({ shape: new Rect(vec2(0), 4, 16) }), body({ isStatic: true }), tile({ isObstacle: true })],
                "b": () => [sprite("wall_botright"), area({ shape: new Rect(vec2(12, 0), 4, 16) }), body({ isStatic: true }), tile({ isObstacle: true })],
                "c": () => [sprite("wall_topleft"), area(), body({ isStatic: true }), tile({ isObstacle: true })],
                "d": () => [sprite("wall_topright"), area(), body({ isStatic: true }), tile({ isObstacle: true })],
                "w": () => [sprite("wall"), area(), body({ isStatic: true }), tile({ isObstacle: true })],
                "t": () => [sprite("wall_top"), area({ shape: new Rect(vec2(0, 12), 16, 4) }), body({ isStatic: true }), tile({ isObstacle: true })],
                "l": () => [sprite("wall_left"), area({ shape: new Rect(vec2(0), 4, 16) }), body({ isStatic: true }), tile({ isObstacle: true })],
                "r": () => [sprite("wall_right"), area({ shape: new Rect(vec2(12, 0), 4, 16) }), body({ isStatic: true }), tile({ isObstacle: true })],
            },
        });

        const player = map.spawn([
            sprite("hero", { anim: "idle" }),
            area({ shape: new Rect(vec2(0, 6), 12, 12) }),
            body(),
            anchor("center"),
            tile(),
        ], 2, 2);

        map.spawn([
            sprite("ogre"),
            anchor("bot"),
            area({ scale: 0.5 }),
            body({ isStatic: true }),
            tile({ isObstacle: true }),
        ], 5, 4);

        // ===== Interaction =====
        function interact() {
            for (const col of player.getCollisions()) {
                const c = col.target;
                if (c.is("chest")) {
                    if (c.opened) { c.play("close"); c.opened = false; }
                    else { c.play("open"); c.opened = true; }
                }
            }
        }

        const SPEED = 120;

        // ===== Touch controls =====
        const pressed = new Set();
        const dirVec = () => {
            let x = 0, y = 0;
            if (pressed.has("left")) x -= 1;
            if (pressed.has("right")) x += 1;
            if (pressed.has("up")) y -= 1;
            if (pressed.has("down")) y += 1;
            const v = vec2(x, y);
            return v.len() > 0 ? v.unit() : v;
        };

        const startPress = (d) => {
            pressed.add(d);
            const v = dirVec();
            if (v.x < 0) player.flipX = true;
            if (v.x > 0) player.flipX = false;
            if (player.curAnim() !== "run" && (v.x || v.y)) player.play("run");
        };
        const stopPress = (d) => {
            pressed.delete(d);
            const v = dirVec();
            if (!v.x && !v.y && player.curAnim() !== "idle") player.play("idle");
            if (v.x < 0) player.flipX = true;
            if (v.x > 0) player.flipX = false;
        };

        onUpdate(() => {
            const v = dirVec();
            player.move(v.scale(SPEED));
            camPos(player.pos);
            if (!v.x && !v.y && player.curAnim() !== "idle") player.play("idle");
            else if ((v.x || v.y) && player.curAnim() !== "run") player.play("run");
        });

        player.onPhysicsResolve(() => camPos(player.pos));

        const dpad = document.getElementById("dpad");
        const actionBtn = document.getElementById("btn-action");

        const bindHold = (el, dir) => {
            const down = (e) => { e.preventDefault(); startPress(dir); el.setPointerCapture?.(e.pointerId); };
            const up = (e) => { e.preventDefault(); stopPress(dir); el.releasePointerCapture?.(e.pointerId); };
            el.addEventListener("pointerdown", down, { passive: false });
            el.addEventListener("pointerup", up, { passive: false });
            el.addEventListener("pointercancel", up, { passive: false });
            el.addEventListener("pointerleave", up, { passive: false });
        };

        dpad.querySelectorAll("button[data-dir]").forEach(btn => bindHold(btn, btn.dataset.dir));
        actionBtn.addEventListener("pointerdown", (e) => { e.preventDefault(); actionBtn.setPointerCapture?.(e.pointerId); interact(); });
        actionBtn.addEventListener("pointerup", (e) => { e.preventDefault(); actionBtn.releasePointerCapture?.(e.pointerId); });
    </script>
</body>
</html>
